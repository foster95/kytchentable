{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="container mb-5">
  <h2 class="text-center mb-4">Welcome back, {{ user.first_name|default:user.username }}</h2>

  <h3 class="text-center mt-4">Your Upcoming Reservations</h3>

  {% if reservations %}
  <div class="row justify-content-center mt-4">
      {% for booking in reservations %}
      <div class="col-md-6 col-lg-4 mb-4">
          <div class="card shadow-sm h-100">
              <div class="card-body">
                  <h5 class="card-title">
                      {{ booking.reservation_date|date:"l, d M Y" }}
                  </h5>
                  <p class="card-text mb-1"><strong>Time:</strong> {{ booking.time_slot }}</p>
                  <p class="card-text mb-1"><strong>Guests:</strong> {{ booking.number_of_guests }}</p>

                  <button type="button"
                          class="btn btn-outline-dark btn-sm mt-2 edit-btn mx-auto"
                          data-booking-id="{{ booking.id }}"
                          data-booking-name="{{ booking.guest_name }}"
                          data-booking-email="{{ booking.guest_email }}"
                          data-booking-phone="{{ booking.guest_phone }}"
                          data-date="{{ booking.reservation_date|date:'Y-m-d' }}"
                          data-time="{{ booking.time_slot }}"
                          data-guests="{{ booking.number_of_guests }}"
                          data-allergies="{% for a in booking.allergies.all %}{{ a.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                          data-special-requests="{{ booking.special_requests }}"
                          data-bs-toggle="modal"
                          data-bs-target="#editReservationModal">
                      Edit Reservation
                  </button>

                  <button type="button"
                          class="btn btn-outline-danger btn-sm mt-2 delete-btn mx-auto"
                          data-booking-id="{{ booking.id }}"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteReservationModal">
                      Delete Reservation
                  </button>
              </div>
          </div>
      </div>
      {% endfor %}
  </div>
  {% else %}
      <p class="text-center text-muted mt-3">You have no upcoming reservations.</p>
  {% endif %}
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <form id="edit-reservation-form" method="post" action="{% url 'update_reservation' %}">
        {% csrf_token %}

        <input type="hidden" name="booking_id" id="booking_id">

        <div class="modal-header">
          <h5 class="modal-title">Edit Reservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div id="modal-errors" class="mb-3"></div>

          <label>Name</label>
          <input type="text" class="form-control mb-3" id="id_guest_name" name="guest_name" required>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Email</label>
              <input type="email" class="form-control" id="id_guest_email" name="guest_email" required>
            </div>

            <div class="col-md-6 mb-3">
              <label>Phone</label>
              <input type="tel" 
                class="form-control"
                id="id_guest_phone"
                name="guest_phone"
                required
                pattern="^\+?[0-9\s\-\(\)]{7,20}$"
                title="Please enter a valid phone number.">
            </div>
          </div>

          <label>Date</label>
          <input type="date" class="form-control mb-3" id="id_date" name="reservation_date" required>

          <label>Time Slot</label>
          <select class="form-select mb-3" id="id_time_slot" name="time_slot">
            {% for time, label in TIME_SLOTS %}
              <option value="{{ time }}">{{ label }}</option>
            {% endfor %}
          </select>

          <label>Guests</label>
          <select class="form-select mb-3" id="id_guests" name="number_of_guests">
            {% for count, label in NO_GUESTS %}
              <option value="{{ count }}">{{ label }}</option>
            {% endfor %}
          </select>

          <label class="mt-3 d-block">Allergies</label>
          <div class="row row-cols-2" id="id_allergens">
            {% for allergen in allergens %}
            <div class="col form-check">
              <input type="checkbox"
                     class="form-check-input allergy-checkbox"
                     name="allergies"
                     id="allergen_{{ allergen.id }}"
                     value="{{ allergen.id }}">
              <label class="form-check-label" for="allergen_{{ allergen.id }}">{{ allergen.name }}</label>
            </div>
            {% endfor %}
          </div>

          <div class="text-end mt-2">
            <button type="button" id="clear-allergies-button" class="btn btn-sm btn-outline-secondary">
              Clear all
            </button>
          </div>

          <label class="mt-3">Special Requests</label>
          <textarea class="form-control" id="id_special_requests" name="special_requests"></textarea>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-dark">Save changes</button>
        </div>

      </form>

    </div>
  </div>
</div>


<!-- DELETE MODAL -->
<div class="modal fade" id="deleteReservationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="delete-form" method="post">
        {% csrf_token %}
        <div class="modal-body text-center">
          <p>Are you sure you want to delete this reservation?</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="submit" class="btn btn-danger">Yes, delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block js %}
<script>
    window.SHOULD_REOPEN_MODAL = {% if reopen_modal %}true{% else %}false{% endif %};
</script>
<script src="{% static 'js/edit_reservation.js' %}"></script>
{% endblock %}
